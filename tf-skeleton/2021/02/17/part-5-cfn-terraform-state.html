<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Terraform Skeleton Part 5: Remote State with CloudFormation | thirstydeveloper</title>
<meta name="generator" content="Jekyll v3.9.0" />
<meta property="og:title" content="Terraform Skeleton Part 5: Remote State with CloudFormation" />
<meta name="author" content="Chris" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Part 3 showed us Terraform requires some infrastructure itself to store remote state and discussed some limitations of using Terragrunt to manage the creation of that infrastructure. In part 4, we introduced more operational infrastructure for Terraform and began managing that infrastructure with CloudFormation." />
<meta property="og:description" content="Part 3 showed us Terraform requires some infrastructure itself to store remote state and discussed some limitations of using Terragrunt to manage the creation of that infrastructure. In part 4, we introduced more operational infrastructure for Terraform and began managing that infrastructure with CloudFormation." />
<link rel="canonical" href="https://thirstydeveloper.io/tf-skeleton/2021/02/17/part-5-cfn-terraform-state.html" />
<meta property="og:url" content="https://thirstydeveloper.io/tf-skeleton/2021/02/17/part-5-cfn-terraform-state.html" />
<meta property="og:site_name" content="thirstydeveloper" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-02-17T12:20:00+00:00" />
<script type="application/ld+json">
{"description":"Part 3 showed us Terraform requires some infrastructure itself to store remote state and discussed some limitations of using Terragrunt to manage the creation of that infrastructure. In part 4, we introduced more operational infrastructure for Terraform and began managing that infrastructure with CloudFormation.","url":"https://thirstydeveloper.io/tf-skeleton/2021/02/17/part-5-cfn-terraform-state.html","@type":"BlogPosting","headline":"Terraform Skeleton Part 5: Remote State with CloudFormation","dateModified":"2021-02-17T12:20:00+00:00","datePublished":"2021-02-17T12:20:00+00:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://thirstydeveloper.io/tf-skeleton/2021/02/17/part-5-cfn-terraform-state.html"},"author":{"@type":"Person","name":"Chris"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="https://thirstydeveloper.io/feed.xml" title="thirstydeveloper" /><script>
if(!(window.doNotTrack === "1" || navigator.doNotTrack === "1" || navigator.doNotTrack === "yes" || navigator.msDoNotTrack === "1")) {
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-108404407-1', 'auto');
  ga('send', 'pageview');
}
</script>
  
</head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">thirstydeveloper</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a><a class="page-link" href="/series/tf-skeleton.html">Terraform Skeleton</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Terraform Skeleton Part 5: Remote State with CloudFormation</h1>
    <p class="post-meta"><time class="dt-published" datetime="2021-02-17T12:20:00+00:00" itemprop="datePublished">
        Feb 17, 2021
      </time>‚Ä¢ 
          <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <span class="p-author h-card" itemprop="name">Chris</span></span>
        <span class="post-series">
          ‚Ä¢ Part of the <a href="/series/tf-skeleton">tf-skeleton series</a>
        </span><br />
        <span itemprop="drink"><span class="drink-icon" itemprop="name">üç∏ </span><span class="h-card" itemprop="name">Margarita on the Rocks </span><br />
          <span class="h-card" itemprop="name">Fresh Lime Juice ‚Ä¢ Cabo Wabo Blanco ‚Ä¢ Bols Triple Sec ‚Ä¢ (2:2:3)</span>
        </span></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p><a href="/tf-skeleton/2021/01/28/part-3-aws-backend.html">Part 3</a> showed us Terraform requires some infrastructure itself to store remote state and discussed some <a href="/tf-skeleton/2021/01/28/part-3-aws-backend.html#limitations">limitations</a> of using Terragrunt to manage the creation of that infrastructure. In <a href="/tf-skeleton/2021/02/10/part-4-backend-role.html">part 4</a>, we introduced more operational infrastructure for Terraform and <a href="/tf-skeleton/2021/02/10/part-4-backend-role.html#admin-account-cloudformation-template">began managing that infrastructure with CloudFormation</a>.</p>

<p>Today, we‚Äôll continue down the path of using CloudFormation to store operational Terraform infrastructure. Achieving a clean separation between the infrastructure Terraform needs to run and the infrastructure Terraform manages opens up additional possibilities for locking down the Terraform state.</p>

<p>We‚Äôll make use of <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/resource-import.html">CloudFormation‚Äôs import feature</a> to bring the state bucket and lock table Terragrunt created for us under CloudFormation‚Äôs control for a seamless transition of ownership.</p>

<h1 id="goals">Goals</h1>

<ol>
  <li>Control all Terraform operational infrastructure with CloudFormation</li>
  <li>Import existing operational infrastructure (buckets, tables) into CloudFormation</li>
</ol>

<p>If you prefer to jump to the end, the code implementing this post‚Äôs final result is available on branch <a href="https://github.com/thirstydeveloper/terraform-terragrunt-skeleton/tree/release/1.4">release/1.4</a> on GitHub. Additionally, you can <a href="https://github.com/thirstydeveloper/terraform-terragrunt-skeleton/compare/release/1.3...release/1.4">view the diffs from part 4</a>, if that‚Äôs more your speed.</p>

<h1 id="define-operational-infrastructure-with-cloudformation">Define Operational Infrastructure with CloudFormation</h1>

<p>There are three items we need to import into CloudFormation:</p>

<ol>
  <li>The state S3 bucket</li>
  <li>The log S3 bucket</li>
  <li>The DynamoDB lock table</li>
</ol>

<p>The first step is to define these resources in a CloudFormation template. We‚Äôll add resource definitions to the <code class="language-plaintext highlighter-rouge">init-admin-account.cf.yml</code> template <a href="/tf-skeleton/2021/02/10/part-4-backend-role.html#admin-account-cloudformation-template">we created in part 4</a>.</p>

<p>If you prefer, you can <a href="https://github.com/thirstydeveloper/terraform-terragrunt-skeleton/compare/release/1.3...release/1.4#diff-cc93827adede14cb1e69dde0ed0769a47014bbb00f7ec444c61b927f3901c35a">view the diffs</a> on the CloudFormation template from part 4.</p>

<p>First up, the state bucket. Add an <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-s3-bucket.html">AWS::S3::Bucket</a> resource to the CloudFormation template for our state bucket under the <code class="language-plaintext highlighter-rouge">Resources</code> block:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">TerraformStateBucket</span><span class="pi">:</span>
  <span class="na">Type</span><span class="pi">:</span> <span class="s1">'</span><span class="s">AWS::S3::Bucket'</span>
  <span class="na">DeletionPolicy</span><span class="pi">:</span> <span class="s">Retain</span>
  <span class="na">UpdateReplacePolicy</span><span class="pi">:</span> <span class="s">Retain</span>
  <span class="na">Properties</span><span class="pi">:</span>
    <span class="na">BucketName</span><span class="pi">:</span> <span class="kt">!Ref</span> <span class="s">StateBucketName</span>
    <span class="na">BucketEncryption</span><span class="pi">:</span>
      <span class="na">ServerSideEncryptionConfiguration</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">ServerSideEncryptionByDefault</span><span class="pi">:</span>
            <span class="na">SSEAlgorithm</span><span class="pi">:</span> <span class="s">aws:kms</span>
    <span class="na">LoggingConfiguration</span><span class="pi">:</span>
      <span class="na">DestinationBucketName</span><span class="pi">:</span> <span class="kt">!Ref</span> <span class="s">StateLogBucketName</span>
      <span class="na">LogFilePrefix</span><span class="pi">:</span> <span class="s">TFStateLogs/</span>
    <span class="na">PublicAccessBlockConfiguration</span><span class="pi">:</span>
      <span class="na">BlockPublicAcls</span><span class="pi">:</span> <span class="s">True</span>
      <span class="na">BlockPublicPolicy</span><span class="pi">:</span> <span class="s">True</span>
      <span class="na">IgnorePublicAcls</span><span class="pi">:</span> <span class="s">True</span>
      <span class="na">RestrictPublicBuckets</span><span class="pi">:</span> <span class="s">True</span>
    <span class="na">VersioningConfiguration</span><span class="pi">:</span>
      <span class="na">Status</span><span class="pi">:</span> <span class="s">Enabled</span>
</code></pre></div></div>

<p>The properties above match what Terragrunt used <a href="/tf-skeleton/2021/01/28/part-3-aws-backend.html#backend-configuration-with-terragrunt">when it created the state bucket in part 3</a>. Note that we‚Äôre also using the <code class="language-plaintext highlighter-rouge">StateBucketName</code> and <code class="language-plaintext highlighter-rouge">StateLogBucketName</code> <a href="/tf-skeleton/2021/02/10/part-4-backend-role.html#admin-account-cloudformation-template">parameters we added in part 4</a>.</p>

<p>CloudFormation <a href="https://docs.amazonaws.cn/en_us/AWSCloudFormation/latest/UserGuide/resource-import-existing-stack.html">requires the DeletionPolicy attribute</a> for any resources it will import, and it is a good safety measure in general.</p>

<p><a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-attribute-updatereplacepolicy.html">UpdateReplacePolicy</a> is also set. Although not required, it is needed to make our <a href="/tf-skeleton/2021/02/10/part-4-backend-role.html#preparation">CloudFormation linter pre-commit hook</a> happy.<sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote">1</a></sup></p>

<p>Next, we‚Äôll tackle the log bucket. Add the following to the <code class="language-plaintext highlighter-rouge">Resources</code> block:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">TerraformStateLogBucket</span><span class="pi">:</span>
  <span class="na">Type</span><span class="pi">:</span> <span class="s1">'</span><span class="s">AWS::S3::Bucket'</span>
  <span class="na">DeletionPolicy</span><span class="pi">:</span> <span class="s">Retain</span>
  <span class="na">UpdateReplacePolicy</span><span class="pi">:</span> <span class="s">Retain</span>
  <span class="na">Properties</span><span class="pi">:</span>
    <span class="na">BucketName</span><span class="pi">:</span> <span class="kt">!Ref</span> <span class="s">StateLogBucketName</span>
    <span class="na">AccessControl</span><span class="pi">:</span> <span class="s">LogDeliveryWrite</span>
</code></pre></div></div>

<p>Finally, we have the lock table:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">TerraformStateLockTable</span><span class="pi">:</span>
  <span class="na">Type</span><span class="pi">:</span> <span class="s1">'</span><span class="s">AWS::DynamoDB::Table'</span>
  <span class="na">DeletionPolicy</span><span class="pi">:</span> <span class="s">Retain</span>
  <span class="na">UpdateReplacePolicy</span><span class="pi">:</span> <span class="s">Retain</span>
  <span class="na">Properties</span><span class="pi">:</span>
    <span class="na">TableName</span><span class="pi">:</span> <span class="kt">!Ref</span> <span class="s">LockTableName</span>
    <span class="na">AttributeDefinitions</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">AttributeName</span><span class="pi">:</span> <span class="s">LockID</span>
        <span class="na">AttributeType</span><span class="pi">:</span> <span class="s">S</span>
    <span class="na">KeySchema</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">AttributeName</span><span class="pi">:</span> <span class="s">LockID</span>
        <span class="na">KeyType</span><span class="pi">:</span> <span class="s">HASH</span>
    <span class="na">BillingMode</span><span class="pi">:</span> <span class="s">PAY_PER_REQUEST</span>
</code></pre></div></div>

<p>If you‚Äôre starting fresh, and Terragrunt hasn‚Äôt already created the state bucket, log bucket, and lock table for you, you can skip the next section on importing and run the <code class="language-plaintext highlighter-rouge">make init-admin</code> target we created in <a href="/tf-skeleton/2021/01/28/part-3-aws-backend.html">part 3</a> to deploy your stack. Otherwise, continue on to import the resources Terragrunt created for you.</p>

<h1 id="import-operational-infrastructure-into-cloudformation">Import Operational Infrastructure into CloudFormation</h1>

<p>While you can use the AWS management console to import the resources, I prefer to work from the command line, but the commands to do so aren‚Äôt straightforward. We‚Äôll add some targets to our Makefile in an attempt to simplify.</p>

<p>For a clean import, we need the following capabilities in our Makefile:</p>

<ol>
  <li>Use <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/using-cfn-stack-drift.html">CloudFormation Drift Detection</a> to ensure our stack is up-to-date and our resource definitions match what Terragrunt created</li>
  <li>Create a <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/using-cfn-updating-stacks-changesets.html">CloudFormation change set</a> to import the resources and show us what CloudFormation intends to do</li>
  <li>Execute the change set to import the resources</li>
</ol>

<p>If you prefer to jump to the end, <a href="https://github.com/thirstydeveloper/terraform-terragrunt-skeleton/blob/release/1.4/Makefile">here‚Äôs the resulting Makefile</a>, and here are <a href="https://github.com/thirstydeveloper/terraform-terragrunt-skeleton/compare/release/1.3...release/1.4#diff-76ed074a9305c04054cdebb9e9aad2d818052b07091de1f20cad0bbac34ffb52">the diffs from part 4</a>.</p>

<h2 id="check-for-drift">Check for Drift</h2>

<p>The first step in the import process is to verify that the stack we will be importing into has no drift, i.e., it has no other unapplied changes. The CloudFormation API uses separate calls to <a href="https://docs.aws.amazon.com/cli/latest/reference/cloudformation/detect-stack-drift.html">start a drift detection job</a> and <a href="https://docs.aws.amazon.com/cli/latest/reference/cloudformation/describe-stack-drift-detection-status.html">check the status of a drift detection job</a>. We‚Äôll add some helper functions to our Makefile to wrap these calls:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>define wait_cfn_drift_detect_job
	@while [[ \
		"$$($(CFN_STATUS_DRIFT_DETECTION) $(1) | jq -r .DetectionStatus)" == \
		"DETECTION_IN_PROGRESS" \
	]]; do \
		echo "Detection in progress. Waiting 3 seconds..."; \
		sleep 3; \
	done
endef

define show_cfn_drift
	$(eval DRIFT_ID=$(shell $(CFN_START_DRIFT_DETECTION) $(1) \
		| jq -r .StackDriftDetectionId))
	$(call wait_cfn_drift_detect_job,${DRIFT_ID})
	@$(CFN_STATUS_DRIFT_DETECTION) $(DRIFT_ID) | jq '{ \
		DetectionStatus, \
		StackDriftStatus, \
		DriftedStackResourceCount \
	}'
endef
</code></pre></div></div>

<p>Next, add a make target to perform the drift detection:</p>

<div class="language-make highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">.PHONY</span><span class="o">:</span> <span class="nf">check-init-admin-drift</span>
<span class="nl">check-init-admin-drift</span><span class="o">:</span>
	<span class="nf">$(</span><span class="nb">call</span> show_cfn_drift,<span class="nv">${ADMIN_INIT_STACK_NAME}</span><span class="nf">)</span>
</code></pre></div></div>

<p>Execute drift detection with:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>‚ûú make check-init-admin-drift
Detection <span class="k">in </span>progress. Waiting 3 seconds...
<span class="o">{</span>
  <span class="s2">"DetectionStatus"</span>: <span class="s2">"DETECTION_COMPLETE"</span>,
  <span class="s2">"StackDriftStatus"</span>: <span class="s2">"IN_SYNC"</span>,
  <span class="s2">"DriftedStackResourceCount"</span>: 0
<span class="o">}</span>
</code></pre></div></div>

<p>If you get a <code class="language-plaintext highlighter-rouge">StackDriftStatus</code> other than <code class="language-plaintext highlighter-rouge">IN_SYNC</code>, adjust your CloudFormation template to resolve, and verify using the drift check. Once you‚Äôre <code class="language-plaintext highlighter-rouge">IN_SYNC</code>, create the import change set as follows.</p>

<h2 id="create-import-changeset">Create Import Changeset</h2>

<p>Creating the import change set requires a CloudFormation template and information about the resources to import, including:</p>

<ol>
  <li>The resource type</li>
  <li>The logical name of the resource in your template</li>
  <li>The unique identifier for that resource in AWS</li>
</ol>

<p>For instance, our CloudFormation template defines the state bucket with:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">Resources</span><span class="pi">:</span>
  <span class="na">TerraformStateLogBucket</span><span class="pi">:</span>
    <span class="na">Type</span><span class="pi">:</span> <span class="s1">'</span><span class="s">AWS::S3::Bucket'</span>
    <span class="s">...</span>
</code></pre></div></div>

<p>which means the resource type is <code class="language-plaintext highlighter-rouge">AWS::S3::Bucket</code>, and the logical name is <code class="language-plaintext highlighter-rouge">TerraformStateLogBucket</code>.</p>

<p>The unique identifier depends on the resource type. For an S3 bucket, it‚Äôs the bucket name. For a DynamoDB table, it‚Äôs the table name.</p>

<p>Below is a make target for creating the import change set:</p>

<div class="language-make highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">import-terragrunt-changeset.json</span><span class="o">:</span>
	<span class="p">@</span>aws cloudformation create-change-set <span class="se">\</span>
		<span class="nt">--stack-name</span> <span class="nv">${ADMIN_INIT_STACK_NAME}</span> <span class="se">\</span>
		<span class="nt">--change-set-name</span> <span class="nv">${ADMIN_INIT_STACK_NAME}</span><span class="nt">-import-terragrunt</span> <span class="se">\</span>
		<span class="nt">--change-set-type</span> IMPORT <span class="se">\</span>
		<span class="nt">--template-body</span> file://init/admin/init-admin-account.cf.yml <span class="se">\</span>
		<span class="nt">--capabilities</span> CAPABILITY_NAMED_IAM <span class="se">\</span>
		<span class="nt">--parameters</span> <span class="se">\</span>
			<span class="nv">ParameterKey</span><span class="o">=</span>AdminAccountId,UsePreviousValue<span class="o">=</span>True <span class="se">\</span>
			<span class="nv">ParameterKey</span><span class="o">=</span>StateBucketName,UsePreviousValue<span class="o">=</span>True <span class="se">\</span>
			<span class="nv">ParameterKey</span><span class="o">=</span>StateLogBucketName,UsePreviousValue<span class="o">=</span>True <span class="se">\</span>
			<span class="nv">ParameterKey</span><span class="o">=</span>LockTableName,UsePreviousValue<span class="o">=</span>True <span class="se">\</span>
		<span class="nt">--resources-to-import</span> <span class="s2">"[ </span><span class="se">\</span><span class="s2">
			{ </span><span class="se">\</span><span class="s2">
				</span><span class="se">\"</span><span class="s2">ResourceType</span><span class="se">\"</span><span class="s2">:</span><span class="se">\"</span><span class="s2">AWS::S3::Bucket</span><span class="se">\"</span><span class="s2">, </span><span class="se">\</span><span class="s2">
				</span><span class="se">\"</span><span class="s2">LogicalResourceId</span><span class="se">\"</span><span class="s2">:</span><span class="se">\"</span><span class="s2">TerraformStateBucket</span><span class="se">\"</span><span class="s2">, </span><span class="se">\</span><span class="s2">
				</span><span class="se">\"</span><span class="s2">ResourceIdentifier</span><span class="se">\"</span><span class="s2">: { </span><span class="se">\</span><span class="s2">
					</span><span class="se">\"</span><span class="s2">BucketName</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="nv">${STATE_BUCKET_NAME}</span><span class="se">\"</span><span class="s2"> </span><span class="se">\</span><span class="s2">
				} </span><span class="se">\</span><span class="s2">
			}, </span><span class="se">\</span><span class="s2">
			{ </span><span class="se">\</span><span class="s2">
				</span><span class="se">\"</span><span class="s2">ResourceType</span><span class="se">\"</span><span class="s2">:</span><span class="se">\"</span><span class="s2">AWS::S3::Bucket</span><span class="se">\"</span><span class="s2">, </span><span class="se">\</span><span class="s2">
				</span><span class="se">\"</span><span class="s2">LogicalResourceId</span><span class="se">\"</span><span class="s2">:</span><span class="se">\"</span><span class="s2">TerraformStateLogBucket</span><span class="se">\"</span><span class="s2">, </span><span class="se">\</span><span class="s2">
				</span><span class="se">\"</span><span class="s2">ResourceIdentifier</span><span class="se">\"</span><span class="s2">: { </span><span class="se">\</span><span class="s2">
					</span><span class="se">\"</span><span class="s2">BucketName</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="nv">${STATE_LOG_BUCKET_NAME}</span><span class="se">\"</span><span class="s2"> </span><span class="se">\</span><span class="s2">
				} </span><span class="se">\</span><span class="s2">
			}, </span><span class="se">\</span><span class="s2">
			{ </span><span class="se">\</span><span class="s2">
			</span><span class="se">\"</span><span class="s2">ResourceType</span><span class="se">\"</span><span class="s2">:</span><span class="se">\"</span><span class="s2">AWS::DynamoDB::Table</span><span class="se">\"</span><span class="s2">, </span><span class="se">\</span><span class="s2">
				</span><span class="se">\"</span><span class="s2">LogicalResourceId</span><span class="se">\"</span><span class="s2">:</span><span class="se">\"</span><span class="s2">TerraformStateLockTable</span><span class="se">\"</span><span class="s2">, </span><span class="se">\</span><span class="s2">
				</span><span class="se">\"</span><span class="s2">ResourceIdentifier</span><span class="se">\"</span><span class="s2">: { </span><span class="se">\</span><span class="s2">
					</span><span class="se">\"</span><span class="s2">TableName</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="nv">${LOCK_TABLE_NAME}</span><span class="se">\"</span><span class="s2"> </span><span class="se">\</span><span class="s2">
				} </span><span class="se">\</span><span class="s2">
			} </span><span class="se">\</span><span class="s2">
		]"</span> | <span class="nb">tee </span>import-terragrunt-changeset.json
</code></pre></div></div>

<p>CloudFormation assigns each change set a unique ID needed for describing, executing, or discarding the change set with subsequent API calls. The <code class="language-plaintext highlighter-rouge">import-terragrunt-changeset.json</code> stores the change set identifier in a JSON file for our other make targets to consume.</p>

<p>Next, we want a target for describing the created change set so we can see what modifications it will make:</p>

<div class="language-make highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">.PHONY</span><span class="o">:</span> <span class="nf">prepare-cfn-import-terragrunt</span>
<span class="nl">prepare-cfn-import-terragrunt</span><span class="o">:</span> <span class="nf">import-terragrunt-changeset.json</span>
	<span class="nf">$(</span><span class="nb">eval</span> <span class="nv">CHANGE_SET_ID</span><span class="o">=</span><span class="nf">$(</span><span class="nb">shell</span> jq <span class="nt">-r</span> .Id import-terragrunt-changeset.json<span class="nf">))</span>
	aws cloudformation <span class="nb">wait </span>change-set-create-complete <span class="se">\</span>
		<span class="nt">--change-set-name</span> <span class="nv">${CHANGE_SET_ID}</span> <span class="se">\</span>
		<span class="nt">--stack-name</span> <span class="nv">${ADMIN_INIT_STACK_NAME}</span>
	<span class="p">@</span>aws cloudformation describe-change-set <span class="se">\</span>
		<span class="nt">--change-set-name</span> <span class="nv">${CHANGE_SET_ID}</span> <span class="se">\</span>
		<span class="nt">--stack-name</span> <span class="nv">${ADMIN_INIT_STACK_NAME}</span> <span class="se">\</span>
		| jq <span class="s1">'{ Changes, Status, StatusReason }'</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">prepare-cfn-import-terragrunt</code> target depends on <code class="language-plaintext highlighter-rouge">import-terragrunt-changeset.json</code> to create the change set and communicate its unique id, then describes it once the change set finishes creating.</p>

<p>At this point, we‚Äôll add another target for discarding the change set, in case we don‚Äôt like what we see with <code class="language-plaintext highlighter-rouge">prepare-cfn-import-terragrunt</code>:</p>

<div class="language-make highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">.PHONY</span><span class="o">:</span> <span class="nf">discard-cfn-import-terragrunt</span>
<span class="nl">discard-cfn-import-terragrunt</span><span class="o">:</span> <span class="nf">import-terragrunt-changeset.json</span>
	<span class="nf">$(</span><span class="nb">eval</span> <span class="nv">CHANGE_SET_ID</span><span class="o">=</span><span class="nf">$(</span><span class="nb">shell</span> jq <span class="nt">-r</span> .Id import-terragrunt-changeset.json<span class="nf">))</span>
	aws cloudformation delete-change-set <span class="se">\</span>
		<span class="nt">--change-set-name</span> <span class="nv">${CHANGE_SET_ID}</span> <span class="se">\</span>
		<span class="nt">--stack-name</span> <span class="nv">${ADMIN_INIT_STACK_NAME}</span>
	<span class="p">@</span><span class="nb">rm </span>import-terragrunt-changeset.json
</code></pre></div></div>

<p>Let‚Äôs add a conventional <code class="language-plaintext highlighter-rouge">clean</code> target too:</p>

<div class="language-make highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">.PHONY</span><span class="o">:</span> <span class="nf">clean</span>
<span class="nl">clean</span><span class="o">:</span>
	<span class="nb">rm </span>import-terragrunt-changeset.json
</code></pre></div></div>

<p>Now, let‚Äôs use our targets to create and describe the change set:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>‚ûú make prepare-cfn-import-terragrunt
<span class="o">{</span>
    <span class="s2">"Id"</span>: <span class="s2">"arn:aws:cloudformation:us-east-1:&lt;omitted&gt;:changeSet/tf-admin-init-import-terragrunt/179b1efd-2961-48af-95c2-6f45b96a9925"</span>,
    <span class="s2">"StackId"</span>: <span class="s2">"arn:aws:cloudformation:us-east-1:&lt;omitted&gt;:stack/tf-admin-init/8704b070-5f61-11eb-9ff1-0eea077046db"</span>
<span class="o">}</span>
aws cloudformation <span class="nb">wait </span>change-set-create-complete <span class="se">\</span>
		<span class="nt">--change-set-name</span> arn:aws:cloudformation:us-east-1:&lt;omitted&gt;:changeSet/tf-admin-init-import-terragrunt/179b1efd-2961-48af-95c2-6f45b96a9925 <span class="se">\</span>
		<span class="nt">--stack-name</span> tf-admin-init
<span class="o">{</span>
  <span class="s2">"Changes"</span>: <span class="o">[</span>
    <span class="o">{</span>
      <span class="s2">"Type"</span>: <span class="s2">"Resource"</span>,
      <span class="s2">"ResourceChange"</span>: <span class="o">{</span>
        <span class="s2">"Action"</span>: <span class="s2">"Import"</span>,
        <span class="s2">"LogicalResourceId"</span>: <span class="s2">"TerraformStateBucket"</span>,
        <span class="s2">"PhysicalResourceId"</span>: <span class="s2">"terraform-skeleton-state"</span>,
        <span class="s2">"ResourceType"</span>: <span class="s2">"AWS::S3::Bucket"</span>,
        <span class="s2">"Scope"</span>: <span class="o">[]</span>,
        <span class="s2">"Details"</span>: <span class="o">[]</span>
      <span class="o">}</span>
    <span class="o">}</span>,
    <span class="o">{</span>
      <span class="s2">"Type"</span>: <span class="s2">"Resource"</span>,
      <span class="s2">"ResourceChange"</span>: <span class="o">{</span>
        <span class="s2">"Action"</span>: <span class="s2">"Import"</span>,
        <span class="s2">"LogicalResourceId"</span>: <span class="s2">"TerraformStateLockTable"</span>,
        <span class="s2">"PhysicalResourceId"</span>: <span class="s2">"terraform-skeleton-state-locks"</span>,
        <span class="s2">"ResourceType"</span>: <span class="s2">"AWS::DynamoDB::Table"</span>,
        <span class="s2">"Scope"</span>: <span class="o">[]</span>,
        <span class="s2">"Details"</span>: <span class="o">[]</span>
      <span class="o">}</span>
    <span class="o">}</span>,
    <span class="o">{</span>
      <span class="s2">"Type"</span>: <span class="s2">"Resource"</span>,
      <span class="s2">"ResourceChange"</span>: <span class="o">{</span>
        <span class="s2">"Action"</span>: <span class="s2">"Import"</span>,
        <span class="s2">"LogicalResourceId"</span>: <span class="s2">"TerraformStateLogBucket"</span>,
        <span class="s2">"PhysicalResourceId"</span>: <span class="s2">"terraform-skeleton-state-logs"</span>,
        <span class="s2">"ResourceType"</span>: <span class="s2">"AWS::S3::Bucket"</span>,
        <span class="s2">"Scope"</span>: <span class="o">[]</span>,
        <span class="s2">"Details"</span>: <span class="o">[]</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">]</span>,
  <span class="s2">"Status"</span>: <span class="s2">"CREATE_COMPLETE"</span>,
  <span class="s2">"StatusReason"</span>: null
<span class="o">}</span>
</code></pre></div></div>

<p>Our describe command should show three <code class="language-plaintext highlighter-rouge">Import</code> actions occurring in the change list with no other changes. If you see any other actions, it means your template contains unapplied changes, and you‚Äôll want to address those first.</p>

<h2 id="execute-import">Execute Import</h2>

<p>Having created the import change set and verified the actions it staged, we‚Äôll now add a target for executing it:</p>

<div class="language-make highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">.PHONY</span><span class="o">:</span> <span class="nf">cfn-import-terragrunt</span>
<span class="nl">cfn-import-terragrunt</span><span class="o">:</span> <span class="nf">import-terragrunt-changeset.json</span>
	<span class="nf">$(</span><span class="nb">eval</span> <span class="nv">CHANGE_SET_ID</span><span class="o">=</span><span class="nf">$(</span><span class="nb">shell</span> jq <span class="nt">-r</span> .Id import-terragrunt-changeset.json<span class="nf">))</span>
	aws cloudformation <span class="nb">wait </span>change-set-create-complete <span class="se">\</span>
		<span class="nt">--change-set-name</span> <span class="nv">${CHANGE_SET_ID}</span> <span class="se">\</span>
		<span class="nt">--stack-name</span> <span class="nv">${ADMIN_INIT_STACK_NAME}</span>
	aws cloudformation execute-change-set <span class="se">\</span>
		<span class="nt">--change-set-name</span> <span class="nv">${CHANGE_SET_ID}</span> <span class="se">\</span>
		<span class="nt">--stack-name</span> <span class="nv">${ADMIN_INIT_STACK_NAME}</span>
	<span class="p">@</span><span class="nb">rm </span>import-terragrunt-changeset.json
	aws cloudformation <span class="nb">wait </span>stack-import-complete <span class="se">\</span>
		<span class="nt">--stack-name</span> <span class="nv">${ADMIN_INIT_STACK_NAME}</span>
	<span class="nf">$(</span><span class="nb">call</span> show_cfn_drift,<span class="nv">${ADMIN_INIT_STACK_NAME}</span><span class="nf">)</span>
</code></pre></div></div>

<p>Execute the import with:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>‚ûú make cfn-import-terragrunt
aws cloudformation <span class="nb">wait </span>change-set-create-complete <span class="se">\</span>
		<span class="nt">--change-set-name</span> arn:aws:cloudformation:us-east-1:&lt;omitted&gt;:changeSet/tf-admin-init-import-terragrunt/179b1efd-2961-48af-95c2-6f45b96a9925 <span class="se">\</span>
		<span class="nt">--stack-name</span> tf-admin-init
aws cloudformation execute-change-set <span class="se">\</span>
		<span class="nt">--change-set-name</span> arn:aws:cloudformation:us-east-1:&lt;omitted&gt;:changeSet/tf-admin-init-import-terragrunt/179b1efd-2961-48af-95c2-6f45b96a9925 <span class="se">\</span>
		<span class="nt">--stack-name</span> tf-admin-init
aws cloudformation <span class="nb">wait </span>stack-import-complete <span class="se">\</span>
		<span class="nt">--stack-name</span> tf-admin-init
<span class="o">{</span>
  <span class="s2">"DetectionStatus"</span>: <span class="s2">"DETECTION_COMPLETE"</span>,
  <span class="s2">"StackDriftStatus"</span>: <span class="s2">"IN_SYNC"</span>,
  <span class="s2">"DriftedStackResourceCount"</span>: 0
<span class="o">}</span>
</code></pre></div></div>

<p>At the end of the <code class="language-plaintext highlighter-rouge">cfn-import-terragrunt</code> target, we call our <code class="language-plaintext highlighter-rouge">show_cfn_drift</code> helper function to verify that the properties of the resources we imported match what we specified in our template. You should see <code class="language-plaintext highlighter-rouge">StackDriftStatus</code> is <code class="language-plaintext highlighter-rouge">IN_SYNC</code>, which means we‚Äôve successfully imported the resources and the definitions for those resources in our template match reality.<sup id="fnref:2" role="doc-noteref"><a href="#fn:2" class="footnote">2</a></sup></p>

<h1 id="whats-next">What‚Äôs Next</h1>

<p>We‚Äôve now fully separated the creation of operational infrastructure required to run Terraform from the infrastructure Terraform manages. Creating the operational infrastructure with CloudFormation has numerous benefits. We can now harden our state bucket, log bucket, and lock table in ways that were not available to us with Terragrunt managing their creation. We‚Äôll tackle such hardening in upcoming posts.</p>

<h1 id="footnotes">Footnotes</h1>

<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:1" role="doc-endnote">

      <p>If you omit <code class="language-plaintext highlighter-rouge">UpdateReplacePolicy</code>, the linter will report something like:</p>

      <blockquote>
        <p>W3011 Both UpdateReplacePolicy and DeletionPolicy are needed to protect Resources/TerraformStateBucket from deletion</p>
      </blockquote>
      <p><a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:2" role="doc-endnote">

      <p>If you see that there is drift after executing the import change set, the resources you imported have a different configuration than what you specified in your template. For instance, maybe your template specified a bucket is KMS encrypted when in reality, the bucket is AES-256 encrypted. Drift detection will report such differences. To resolve the drift:</p>

      <ol>
        <li>Decide whether the drift is appropriate and should be retained</li>
        <li>Modify the template to match any appropriate drift</li>
        <li>Create a change set on the stack with the updated template</li>
        <li>Verify the change set reports it will discard the inappropriate drift (or have no changes if there was no inappropriate drift)</li>
        <li>Execute the change set</li>
      </ol>
      <p><a href="#fnref:2" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>

  </div><div id="disqus_thread"></div>
  <script>
    var disqus_config = function () {
      this.page.url = 'https://thirstydeveloper.io/tf-skeleton/2021/02/17/part-5-cfn-terraform-state.html';
      this.page.identifier = 'https://thirstydeveloper.io/tf-skeleton/2021/02/17/part-5-cfn-terraform-state.html';
    };

    (function() {
      var d = document, s = d.createElement('script');

      s.src = 'https://thirstydeveloper.disqus.com/embed.js';

      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript><a class="u-url" href="/tf-skeleton/2021/02/17/part-5-cfn-terraform-state.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">thirstydeveloper</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Chris Kent</li><li><a class="u-email" href="mailto:thirstydeveloper@gmail.com">thirstydeveloper@gmail.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/thirstydeveloper"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">thirstydeveloper</span></a></li><li><a href="https://www.linkedin.com/in/thirstydeveloper"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#linkedin"></use></svg> <span class="username">thirstydeveloper</span></a></li><li><a href="https://www.twitter.com/thirstydev"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">thirstydev</span></a></li><li><a href="/feed.xml"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#rss"></use></svg> <span>rss</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>&copy; 2021 Chris Kent. All Rights Reserved. </p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
